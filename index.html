<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8">
<title>Mötesrum Status – Västberga</title>
<style>
body { font-family: Arial, sans-serif; text-align: center; background: #f5f5f5; }
.status { font-size: 4em; font-weight: bold; margin-top: 50px; }
.ledigt { color: green; }
.upptaget { color: red; }
.meeting-info { margin-top: 20px; font-size: 1.2em; }
.meeting-info p { margin: 5px 0; }
</style>
</head>
<body>

<h1>Mötesrum – Västberga</h1>
<div id="status" class="status">Laddar...</div>
<div class="meeting-info">
  <p id="nextMeeting"></p>
  <p id="timeRange"></p>
  <p id="attendees"></p>
  <p id="description"></p>
</div>

<script>
async function updateStatus() {
    const statusEl = document.getElementById("status");
    const nextEl = document.getElementById("nextMeeting");
    const timeEl = document.getElementById("timeRange");
    const attendeesEl = document.getElementById("attendees");
    const descEl = document.getElementById("description");

    try {
        const res = await fetch('https://nodejs-serverless-function-express-beta-dusky.vercel.app/api/roomStatus');
        const data = await res.json();

        const meeting = data.nextMeeting;

        if (meeting) {
            // Konvertera UTC-tid till svensk lokal tid
            const startTime = new Date(meeting.start.dateTime);
            const endTime = new Date(meeting.end.dateTime);
            startTime.setHours(startTime.getHours() + 2);
            endTime.setHours(endTime.getHours() + 2);

            const now = new Date();
            if (startTime <= now && now <= endTime) {
                statusEl.textContent = "Upptaget";
                statusEl.className = "status upptaget";
            } else {
                statusEl.textContent = "Ledigt";
                statusEl.className = "status ledigt";
            }

            const options = { hour: '2-digit', minute: '2-digit' };
            timeEl.textContent = startTime.toLocaleTimeString('sv-SE', options) + " - " +
                                 endTime.toLocaleTimeString('sv-SE', options);

            nextEl.textContent = "Nästa möte: " + meeting.subject;

            // Filtrera bort deltagaren "Mötesrum Test" via namn
            const attendees = (meeting.attendees || [])
                .filter(a => a.emailAddress.name !== 'Mötesrum Test')
                .map(a => a.emailAddress.name)
                .join(", ") || "-";

            attendeesEl.textContent = "Deltagare: " + attendees;
            descEl.textContent = "Beskrivning: " + (meeting.bodyPreview || "-");

            // Ta bort OnlineMeeting-länken (ingen rendering av joinUrl)
        } else {
            statusEl.textContent = "Ledigt";
            nextEl.textContent = "";
            timeEl.textContent = "";
            attendeesEl.textContent = "";
            descEl.textContent = "";
        }

    } catch (err) {
        console.error("Fel vid hämtning av möte:", err);
        statusEl.textContent = "Fel vid laddning";
        nextEl.textContent = "";
        timeEl.textContent = "";
        attendeesEl.textContent = "";
        descEl.textContent = "";
    }
}

// Starta uppdatering och uppdatera varje minut
updateStatus();
setInterval(updateStatus, 60000);
</script>

</body>
</html>
